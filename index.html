<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>健康學習課程紀錄表</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            padding: 20px;
        }
        .check-mark {
            color: #198754;
            font-weight: bold;
            text-align: center;
            font-size: 1.2rem;
        }
        .table-center th,
        .table-center td {
            text-align: center;
            vertical-align: middle;
        }

        /* --- MODIFIED: 修改靠左對齊的規則 --- */
        /* 序號和姓名欄位靠左 (使用 class) */
        .table-center .col-id,
        .table-center .col-name {
             text-align: left;
        }

        /* --- NEW: 手機版 (<= 576px) 規則 --- */
        @media (max-width: 576px) {
            .mobile-hide {
                display: none; /* 隱藏標記 .mobile-hide 的元素 */
            }
            body {
                padding: 10px; /* 手機版邊距小一點 */
            }
            .h3 {
                font-size: 1.5rem; /* 標題小一點 */
            }
            /* 讓手機版表格文字小一點，塞得下更多 */
            .table {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>

    <div class="container-fluid"> <h1 class="h3 mb-3">健康學習課程紀錄表</h1>

        <div id="loading" class="alert alert-secondary" role="alert">
            正在從 Google 試算表載入資料…
        </div>
        <div id="error" class="alert alert-danger d-none" role="alert"></div>

        <div class="table-responsive">
            <table id="dataTable" class="table table-striped table-bordered table-hover table-center">
                <thead id="theadRow" class="table-light">
                </thead>
                <tbody id="tbody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ==== 設定 ====
        const API_KEY = "AIzaSyD14dE-5ouFvIxnTrwF3zhHqFhh9OW0q8c"; 
        const SHEET_ID = "1V_dTMDbUuOj6Oa7E3tFChrQVaJHwcSNac6AIyEY_15A";
        const SHEET_NAME = "工作表1"; 
        const SHEET_RANGE = "A:K";

        // ==== DOM ====
        const $loading = document.getElementById("loading");
        const $error = document.getElementById("error");
        const $thead = document.getElementById("theadRow");
        const $tbody = document.getElementById("tbody");
        const $dataTable = document.getElementById("dataTable");

        const CHECK_ICON = "✔"; 

        document.addEventListener("DOMContentLoaded", fetchAndRender);

        async function fetchAndRender() {
            toggleLoading(true);
            clearError();
            $thead.innerHTML = "";
            $tbody.innerHTML = "";
            $dataTable.classList.add("d-none"); 

            const fullRange = `${SHEET_NAME}!${SHEET_RANGE}`;
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(fullRange)}?key=${API_KEY}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 403) {
                         showError(`讀取失敗 (HTTP ${response.status})：<br>1. 請檢查您的 API 金鑰是否正確。<br>2. 請檢查 Google 試算表是否已開啟「知道連結的任何人皆可檢視」。`);
                    } else if (response.status === 400) {
                         showError(`讀取失敗 (HTTP ${response.status})：<br>1. 請檢查您的 SHEET_ID 是否正確。<br>2. 請檢查工作表名稱 (SHEET_NAME) 是否為「${SHEET_NAME}」。`);
                    } else {
                        throw new Error(`HTTP ${response.status} ${response.statusText}`);
                    }
                    toggleLoading(false);
                    return;
                }

                const data = await response.json();
                const values = data.values || [];

                if (!values.length) {
                    showError("工作表沒有資料。");
                    toggleLoading(false);
                    return;
                }

                const headerRow = values[0];
                const bodyRows = values.slice(1);

                renderTable(headerRow, bodyRows);
                $dataTable.classList.remove("d-none"); 

            } catch (err) {
                console.error(err);
                showError("讀取失敗：" + (err?.message || err) + "。請檢查網路連線或 API 設定。");
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * 將資料渲染到 HTML 表格
         * --- MODIFIED: 此函式已大幅修改 ---
         */
        function renderTable(headerRow, bodyRows) {
            
            // 1. 渲染表頭
            let theadHtml = "<tr>";
            for (let i = 0; i < headerRow.length; i++) {
                const header = headerRow[i];
                const fullHeader = escapeHtml(header);

                if (i === 0) {
                    // 第一欄 (序號): 加上 mobile-hide
                    theadHtml += `<th scope="col" class="col-id mobile-hide">${fullHeader}</th>`;
                } else if (i === 1) {
                    // 第二欄 (姓名): 正常顯示
                    theadHtml += `<th scope="col" class="col-name">${fullHeader}</th>`;
                } else {
                    // 第三欄起 (課堂): 顯示不同版本
                    const classNum = i - 1; // 1, 2, 3...
                    // 手機版: 僅顯示數字
                    const mobileHeader = `<span class="d-inline d-sm-none">${classNum}</span>`; 
                    // 桌機版: 顯示完整標題
                    const desktopHeader = `<span class="d-none d-sm-inline">${fullHeader}</span>`;
                    
                    theadHtml += `<th scope="col" class="col-class">${mobileHeader}${desktopHeader}</th>`;
                }
            }
            theadHtml += "</tr>";
            $thead.innerHTML = theadHtml;

            // 2. 渲染資料列
            let tbodyHtml = "";
            for (const row of bodyRows) {
                if (row.every(cell => (cell || "").trim() === "")) continue;

                tbodyHtml += "<tr>";
                for (let i = 0; i < headerRow.length; i++) {
                    const cellValue = row[i] || "";
                    let cellDisplay = "";
                    let cellClass = "";

                    if (i === 0) {
                        // 第一欄 (序號): 加上 mobile-hide
                        cellClass = "col-id mobile-hide";
                        cellDisplay = escapeHtml(cellValue);
                        tbodyHtml += `<th scope="row" class="${cellClass}">${cellDisplay}</th>`;

                    } else if (i === 1) {
                        // 第二欄 (姓名): 顯示不同版本
                        cellClass = "col-name";
                        const fullName = escapeHtml(cellValue.substring(1, 3));
                        // 手機版: 取前 3 個字
                        const shortName = escapeHtml(cellValue.substring(1, 3)); 
                        
                        const mobileName = `<span class="d-inline d-sm-none">${shortName}</span>`;
                        const desktopName = `<span class="d-none d-sm-inline">${fullName}</span>`;
                        cellDisplay = `${mobileName}${desktopName}`;
                        
                        tbodyHtml += `<td class="${cellClass}">${cellDisplay}</td>`;

                    } else {
                        // 第三欄起 (課堂): 檢查 "V"
                        cellClass = "col-class";
                        if (cellValue.trim().toUpperCase() === "V") {
                            cellDisplay = `<div class="check-mark">${CHECK_ICON}</div>`;
                        } else {
                            cellDisplay = escapeHtml(cellValue);
                        }
                        tbodyHtml += `<td class="${cellClass}">${cellDisplay}</td>`;
                    }
                }
                tbodyHtml += "</tr>";
            }
            $tbody.innerHTML = tbodyHtml;
        }

        // === 小工具 (無變動) ===

        function toggleLoading(show) {
            $loading.classList.toggle("d-none", !show);
        }

        function showError(msg) {
            $error.innerHTML = msg;
            $error.classList.remove("d-none");
        }

        function clearError() {
            $error.textContent = "";
            $error.classList.add("d-none");
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }
    </script>
</body>
</html>
