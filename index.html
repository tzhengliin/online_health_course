<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>健康掌門人-輕鬆學 輕鬆看</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            padding: 20px;
        }
        /* 移除原本表格相關的 CSS，因為表格已刪除 */
        
        /* --- 心得卡片樣式 --- */
        .reflection-card {
            border-left-width: 4px;
            border-left-color: var(--bs-primary);
        }
        .reflection-card-body {
            /* 讓卡片內文中的換行 (Enter) 能夠正確顯示 */
            white-space: pre-wrap; 
        }

        @media (max-width: 576px) {
            body {
                padding: 10px;
            }
            .h3 {
                font-size: 1.5rem;
            }
            /* --- 手機版頁籤文字縮小 --- */
            .nav-tabs .nav-link {
                font-size: 0.9rem;
                padding: 0.5rem 0.6rem;
            }
        }
        
        /* 標題連結樣式微調 (可選) */
        h1 a {
            text-decoration: none;
            color: inherit;
        }
        h1 a:hover {
            text-decoration: underline;
            color: var(--bs-primary);
        }
    </style>
</head>
<body>

    <div class="container-fluid">
        <h1 class="h3 mb-3">
            <a href="https://tzhengliin.github.io/online_health_course/table/" target="_blank">健康掌門人-輕鬆學 輕鬆看(11/12~11/28)</a>
        </h1>
        
        <p>歡迎一起線上輕鬆學營養，我們總共有8部營養學習影片，您只需要把握空檔時間，就可以一起學習，讓自己更健康，每次回饋心得，即可領取獎學金50元。</p>
        
        <div id="loading" class="alert alert-secondary" role="alert">
            正在從 Google 試算表載入心得資料…
        </div>
        <div id="error" class="alert alert-danger d-none" role="alert"></div>

        <h2 class="h4 mt-5 mb-3">學員心得分享區(提供大家互相學習)</h2>

        <ul class="nav nav-tabs nav-fill mb-3" id="reflectionTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="class-1-tab" data-bs-toggle="tab" data-bs-target="#class-1-pane" type="button" role="tab">第一堂</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="class-2-tab" data-bs-toggle="tab" data-bs-target="#class-2-pane" type="button" role="tab">第二堂</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="class-3-tab" data-bs-toggle="tab" data-bs-target="#class-3-pane" type="button" role="tab">第三堂</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="class-4-tab" data-bs-toggle="tab" data-bs-target="#class-4-pane" type="button" role="tab">第四堂</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="class-5-tab" data-bs-toggle="tab" data-bs-target="#class-5-pane" type="button" role="tab">第五堂</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="class-6-tab" data-bs-toggle="tab" data-bs-target="#class-6-pane" type="button" role="tab">第六堂</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="class-7-tab" data-bs-toggle="tab" data-bs-target="#class-7-pane" type="button" role="tab">第七堂</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="class-8-tab" data-bs-toggle="tab" data-bs-target="#class-8-pane" type="button" role="tab">第八堂</button>
            </li>
        </ul>

        <div class="tab-content" id="reflectionTabContent">
            <div class="tab-pane fade show active" id="class-1-pane" role="tabpanel" aria-labelledby="class-1-tab"></div>
            <div class="tab-pane fade" id="class-2-pane" role="tabpanel" aria-labelledby="class-2-tab"></div>
            <div class="tab-pane fade" id="class-3-pane" role="tabpanel" aria-labelledby="class-3-tab"></div>
            <div class="tab-pane fade" id="class-4-pane" role="tabpanel" aria-labelledby="class-4-tab"></div>
            <div class="tab-pane fade" id="class-5-pane" role="tabpanel" aria-labelledby="class-5-tab"></div>
            <div class="tab-pane fade" id="class-6-pane" role="tabpanel" aria-labelledby="class-6-tab"></div>
            <div class="tab-pane fade" id="class-7-pane" role="tabpanel" aria-labelledby="class-7-tab"></div>
            <div class="tab-pane fade" id="class-8-pane" role="tabpanel" aria-labelledby="class-8-tab"></div>
        </div>


    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==== 設定 ====
        const API_KEY = "AIzaSyD14dE-5ouFvIxnTrwF3zhHqFhh9OW0q8c"; 
        const SHEET_ID = "1V_dTMDbUuOj6Oa7E3tFChrQVaJHwcSNac6AIyEY_15A";
        
        // 修改：只需讀取 reflection 工作表
        const SHEET_NAME_REFLECTION = "reflection";
        
        // 讀取範圍
        const SHEET_RANGE = "A:K";

        // ==== DOM ====
        const $loading = document.getElementById("loading");
        const $error = document.getElementById("error");
        // 已移除表格相關的 DOM 變數 ($thead, $tbody, $dataTable)

        document.addEventListener("DOMContentLoaded", fetchAndRender);

        /**
         * 修改：只抓取心得工作表
         */
        async function fetchAndRender() {
            toggleLoading(true);
            clearError();

            // API 網址
            const reflectionRange = `${SHEET_NAME_REFLECTION}!${SHEET_RANGE}`;
            const reflectionUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(reflectionRange)}?key=${API_KEY}`;

            try {
                // 只抓取 reflection
                const respReflection = await fetch(reflectionUrl);

                // 處理回應
                if (!respReflection.ok) {
                    handleFetchError(respReflection, SHEET_NAME_REFLECTION);
                } else {
                    const dataReflection = await respReflection.json();
                    // 渲染心得
                    renderReflections(dataReflection.values || []);
                }

            } catch (err) {
                console.error(err);
                showError("讀取失敗：" + (err?.message || err));
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * 渲染心得卡片到 8 個頁籤
         */
        function renderReflections(values) {
            if (!values || values.length < 2) {
                console.warn("心得工作表沒有資料或只有表頭。");
                return; 
            }
            
            const rows = values.slice(1); // 略過表頭

            // 遍歷 8 個堂課
            for (let classNum = 1; classNum <= 8; classNum++) {
                const pane = document.getElementById(`class-${classNum}-pane`);
                if (!pane) continue; 

                // 假設欄位 C (index 2) 是第一堂, D (index 3) 是第二堂...
                const classColIndex = classNum + 1; 
                
                let cardsHtml = '';
                let reflectionCount = 0;

                // 遍歷所有學員 (每一列)
                for (const row of rows) {
                    const name = row[1].substring(1, 3) || "匿名"; // 假設 B 欄 (index 1) 是姓名
                    const reflectionText = row[classColIndex] || "";

                    // 如果心得文字不是空的，才建立卡片
                    if (reflectionText.trim() !== "") {
                        cardsHtml += createCardHtml(name, reflectionText);
                        reflectionCount++;
                    }
                }

                // 根據是否有心得，填入內容
                if (reflectionCount === 0) {
                    pane.innerHTML = `<div class="alert alert-light">本堂課目前尚無心得。</div>`;
                } else {
                    pane.innerHTML = cardsHtml;
                }
            }
        }

        /**
         * 建立單張心得卡片的 HTML
         */
        function createCardHtml(name, reflectionText) {
            const safeName = escapeHtml(name);
            const safeText = escapeHtml(reflectionText);
            
            return `
                <div class="card mb-3 reflection-card">
                    <div class="card-header fw-bold">${safeName}</div>
                    <div class="card-body reflection-card-body">
                        <p class="card-text">${safeText}</p>
                    </div>
                </div>`;
        }


        // === 小工具 ===

        function toggleLoading(show) {
            $loading.classList.toggle("d-none", !show);
        }

        function showError(msg, append = false) {
            if (append && $error.innerHTML !== "") {
                $error.innerHTML += `<br>${msg}`; 
            } else {
                $error.innerHTML = msg; 
            }
            $error.classList.remove("d-none");
        }
        
        function handleFetchError(response, sheetName) {
            let errorMsg = `讀取「${sheetName}」失敗 (HTTP ${response.status})：`;
            if (response.status === 403) {
                 errorMsg += `請檢查 API 金鑰是否正確，或 Google 試算表是否已開啟「知道連結的任何人皆可檢視」。`;
            } else if (response.status === 400) {
                 errorMsg += `請檢查您的 SHEET_ID 或工作表名稱「${sheetName}」是否正確。`;
            } else {
                errorMsg += response.statusText;
            }
            showError(errorMsg, true);
        }

        function clearError() {
            $error.textContent = "";
            $error.classList.add("d-none");
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }
    </script>
</body>
</html>
