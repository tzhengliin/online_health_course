<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>學員心得管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body {
        padding-top: 2rem;
        background-color: #f8f9fa;
      }
      .container {
        max-width: 800px;
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .class-btn-group {
        margin-bottom: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }
      .class-btn-group .btn {
        flex: 1;
        min-width: 80px;
      }
      #loading-spinner {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2 class="text-center mb-4">學員心得填寫系統</h2>

      <div id="auth-section" class="text-center mb-4">
        <p class="text-muted small">首次使用或更新資料前，請先登入 Google 帳號以取得權限。</p>
        <button id="authorize_button" class="btn btn-primary" onclick="handleAuthClick()">登入 Google 帳號</button>
        <button id="signout_button" class="btn btn-secondary" onclick="handleSignoutClick()" style="display: none">登出</button>
      </div>

      <hr />

      <div class="mb-3">
        <label for="studentSelect" class="form-label fw-bold">1. 選擇學員：</label>
        <select class="form-select" id="studentSelect" disabled>
          <option selected disabled>資料載入中...</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold">2. 選擇課程：</label>
        <div class="class-btn-group" id="classButtons"></div>
      </div>

      <div class="mb-3">
        <label for="reflectionContent" class="form-label fw-bold">3. 心得內容 (<span id="currentLabel">請先選擇學員與課程</span>)：</label>
        <textarea class="form-control" id="reflectionContent" rows="6" disabled></textarea>
      </div>

      <div class="d-grid gap-2">
        <button class="btn btn-success btn-lg" id="updateButton" onclick="updateReflection()" disabled>
          更新心得到 Google 文件
          <span id="loading-spinner" class="spinner-border spinner-border-sm ms-2" role="status"></span>
        </button>
      </div>

      <div id="status-msg" class="mt-3 text-center fw-bold text-primary"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <script>
      /**
       * 設定區
       */
      const API_KEY = "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"; // 請在此填入您的 API KEY
      const CLIENT_ID = "652603876383-qka8rcn6oetrhk5kqnnjd4jtd748gm3a.apps.googleusercontent.com"; // 請在此填入您的 OAuth 2.0 Client ID
      const SHEET_ID = "1V_dTMDbUuOj6Oa7E3tFChrQVaJHwcSNac6AIyEY_15A";

      // *** 重要 ***: 請確認您的 Google 試算表分頁名稱。
      // 根據您的描述，如果是一般預設可能為 '工作表1'，或根據內容可能為 'reflection'
      const TAB_NAME = "reflection";

      const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

      // 欄位對應 (C欄對應第一堂, J欄對應第八堂)
      // A=0, B=1, C=2 ...
      const CLASS_COLUMNS = ["C", "D", "E", "F", "G", "H", "I", "J"];
      const CLASS_NAMES = ["第一堂", "第二堂", "第三堂", "第四堂", "第五堂", "第六堂", "第七堂", "第八堂"];

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;
      let selectedRowIndex = null; // 試算表中的列數 (例如第2列)
      let selectedColLetter = null; // 試算表中的欄位 (例如 'C')

      // 程式載入點
      window.onload = function () {
        gapi.load("client", initializeGapiClient);
        google.accounts.id.initialize({
          client_id: CLIENT_ID,
          callback: (response) => {
            /* Handle credential response */
          },
        });
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: "", // defined later
        });
        gisInited = true;
        generateClassButtons();
      };

      async function initializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
        });
        gapiInited = true;
        maybeEnableButtons();
        // 嘗試讀取學員名單 (如果 API KEY 有權限)
        loadStudents();
      }

      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById("authorize_button").style.display = "inline-block";
        }
      }

      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw resp;
          }
          document.getElementById("signout_button").style.display = "inline-block";
          document.getElementById("authorize_button").style.display = "none";
          loadStudents(); // 登入後重新載入，確保有權限
        };

        if (gapi.client.getToken() === null) {
          tokenClient.requestAccessToken({ prompt: "consent" });
        } else {
          tokenClient.requestAccessToken({ prompt: "" });
        }
      }

      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken("");
          document.getElementById("signout_button").style.display = "none";
          document.getElementById("authorize_button").style.display = "inline-block";
          document.getElementById("studentSelect").innerHTML = "<option disabled selected>請先登入</option>";
        }
      }

      // 產生 1-8 堂課按鈕
      function generateClassButtons() {
        const container = document.getElementById("classButtons");
        CLASS_NAMES.forEach((name, index) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn btn-outline-primary";
          btn.innerText = name;
          btn.onclick = () => selectClass(index, btn);
          container.appendChild(btn);
        });
      }

      // 1. 讀取學員名單 (A欄序號, B欄姓名)
      async function loadStudents() {
        try {
          // 假設標題在第1列，資料從第2列開始。讀取 A2:B
          const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: SHEET_ID,
            range: `${TAB_NAME}!A2:B`,
          });

          const rows = response.result.values;
          const select = document.getElementById("studentSelect");
          select.innerHTML = "<option selected disabled>請選擇學員</option>";

          if (!rows || rows.length === 0) {
            alert("找不到學員資料");
            return;
          }

          // 填充選單，記錄該學員在 Sheet 中的實際列號 (index + 2)
          rows.forEach((row, index) => {
            const serial = row[0] || "";
            const name = row[1] || "未命名";
            const option = document.createElement("option");
            option.value = index + 2; // 試算表列號 (從2開始)
            option.text = `${serial} - ${name}`;
            select.appendChild(option);
          });

          select.disabled = false;
          select.addEventListener("change", (e) => {
            selectedRowIndex = e.target.value;
            resetReflectionArea();
          });
        } catch (err) {
          console.error(err);
          document.getElementById("status-msg").innerText = "無法讀取名單，請確認是否已登入或工作表名稱正確。";
        }
      }

      // 切換課程按鈕
      function selectClass(index, btnElement) {
        // 處理按鈕樣式
        document.querySelectorAll("#classButtons .btn").forEach((b) => {
          b.classList.remove("btn-primary");
          b.classList.add("btn-outline-primary");
        });
        btnElement.classList.remove("btn-outline-primary");
        btnElement.classList.add("btn-primary");

        selectedColLetter = CLASS_COLUMNS[index];
        const className = CLASS_NAMES[index];

        // 更新 UI
        document.getElementById("currentLabel").innerText = className;
        document.getElementById("reflectionContent").disabled = false;
        document.getElementById("updateButton").disabled = false;

        fetchReflection();
      }

      function resetReflectionArea() {
        document.getElementById("reflectionContent").value = "";
        // 如果已經選了課程，重新讀取
        if (selectedRowIndex && selectedColLetter) {
          fetchReflection();
        }
      }

      // 讀取特定學員、特定課程的心得
      async function fetchReflection() {
        if (!selectedRowIndex || !selectedColLetter) return;

        document.getElementById("status-msg").innerText = "讀取中...";
        const range = `${TAB_NAME}!${selectedColLetter}${selectedRowIndex}`;

        try {
          const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: SHEET_ID,
            range: range,
          });

          const values = response.result.values;
          const content = values && values.length > 0 ? values[0][0] : "";

          document.getElementById("reflectionContent").value = content;
          document.getElementById("status-msg").innerText = "";
        } catch (err) {
          console.error(err);
          document.getElementById("status-msg").innerText = "讀取失敗";
        }
      }

      // 更新心得
      async function updateReflection() {
        // 檢查是否已登入 (寫入需要 OAuth Token)
        if (gapi.client.getToken() === null) {
          alert("更新資料需要權限，請先點擊上方的「登入 Google 帳號」。");
          tokenClient.requestAccessToken({ prompt: "consent" });
          return;
        }

        const content = document.getElementById("reflectionContent").value;
        const range = `${TAB_NAME}!${selectedColLetter}${selectedRowIndex}`;

        const spinner = document.getElementById("loading-spinner");
        spinner.style.display = "inline-block";
        document.getElementById("updateButton").disabled = true;

        try {
          const response = await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: SHEET_ID,
            range: range,
            valueInputOption: "RAW",
            resource: {
              values: [[content]],
            },
          });

          document.getElementById("status-msg").innerText = "更新成功！";
          document.getElementById("status-msg").className = "mt-3 text-center fw-bold text-success";
        } catch (err) {
          console.error(err);
          document.getElementById("status-msg").innerText = "更新失敗，請檢查權限。";
          document.getElementById("status-msg").className = "mt-3 text-center fw-bold text-danger";
        } finally {
          spinner.style.display = "none";
          document.getElementById("updateButton").disabled = false;
        }
      }
    </script>
  </body>
</html>
