<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å­¸å“¡å¿ƒå¾—å¡«å¯«ç³»çµ± (å­¸å“¡ç™»å…¥ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body {
        background-color: #f8f9fa;
        padding-top: 2rem;
      }
      .main-card {
        max-width: 800px;
        margin: 0 auto;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        border: none;
        border-radius: 12px;
      }
      .step-label {
        font-weight: bold;
        color: #495057;
        margin-bottom: 0.5rem;
        display: block;
      }
      .btn-group-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .btn-class {
        flex: 1 0 auto;
        min-width: 80px;
      }
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div id="loading-overlay">
      <div id="spinner" class="spinner-border text-primary mb-3" role="status"></div>
      <h4 id="loading-text" class="text-secondary">æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...</h4>
      <div id="auth-container" class="mt-4 hidden text-center">
        <p class="mb-3">è«‹ç™»å…¥æ‚¨çš„ Google å¸³è™Ÿä»¥è®€å–ä¸¦æ’°å¯«å¿ƒå¾—</p>
        <button id="authorize_button" class="btn btn-primary btn-lg shadow"><img src="https://www.svgrepo.com/show/475656/google-color.svg" width="20" class="me-2" />ç™»å…¥ Google</button>
      </div>
      <div id="error-msg" class="text-danger mt-3 fw-bold"></div>
    </div>

    <div class="container">
      <div class="card main-card bg-white p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="m-0">ğŸ“ å­¸å“¡å¿ƒå¾—å¡«å¯«</h3>
          <button id="signout_button" class="btn btn-outline-secondary btn-sm hidden">ç™»å‡º</button>
        </div>

        <div class="mb-4">
          <label for="studentSelect" class="step-label">1. è«‹é¸æ“‡æ‚¨çš„åå­—ï¼š</label>
          <select class="form-select form-select-lg" id="studentSelect" disabled>
            <option selected disabled>ç­‰å¾…è³‡æ–™è¼‰å…¥...</option>
          </select>
          <div class="form-text text-muted">è«‹å‹™å¿…é¸æ“‡æ­£ç¢ºçš„åå­—ï¼Œä»¥å…ä¿®æ”¹åˆ°ä»–äººçš„è³‡æ–™ã€‚</div>
        </div>

        <div class="mb-4">
          <label class="step-label">2. é¸æ“‡èª²ç¨‹ï¼š</label>
          <div class="btn-group-wrap" id="classButtons"></div>
        </div>

        <div class="mb-4">
          <label for="reflectionContent" class="step-label"> 3. å¿ƒå¾—å…§å®¹ (<span id="currentLabel" class="text-primary">è«‹å…ˆé¸æ“‡èª²ç¨‹</span>)ï¼š </label>
          <textarea class="form-control" id="reflectionContent" rows="6" placeholder="é¸æ“‡èª²ç¨‹å¾Œå³å¯é–‹å§‹è¼¸å…¥..." disabled></textarea>
        </div>

        <div class="d-grid">
          <button class="btn btn-success btn-lg" id="updateButton" disabled>æ›´æ–°å„²å­˜åˆ° Google æ–‡ä»¶</button>
        </div>

        <div id="status-area" class="mt-3 text-center fw-bold"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <script>
      // å…¨åŸŸè®Šæ•¸
      let CONFIG = {};
      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      // è©¦ç®—è¡¨æ¬„ä½è¨­å®š
      // å‡è¨­ Cæ¬„=Index 2 (ç¬¬ä¸€å ‚) ... Jæ¬„=Index 9 (ç¬¬å…«å ‚)
      const CLASS_COLUMNS = ["C", "D", "E", "F", "G", "H", "I", "J"];
      const CLASS_NAMES = ["ç¬¬ä¸€å ‚", "ç¬¬äºŒå ‚", "ç¬¬ä¸‰å ‚", "ç¬¬å››å ‚", "ç¬¬äº”å ‚", "ç¬¬å…­å ‚", "ç¬¬ä¸ƒå ‚", "ç¬¬å…«å ‚"];

      // ç•¶å‰ç‹€æ…‹
      let selectedRowIndex = null; // è©¦ç®—è¡¨ä¸­çš„å¯¦éš›åˆ—è™Ÿ (1-based)
      let selectedColLetter = null; // ç•¶å‰é¸æ“‡çš„æ¬„ä½å­—æ¯

      // DOM å…ƒç´ 
      const dom = {
        overlay: document.getElementById("loading-overlay"),
        spinner: document.getElementById("spinner"),
        loadingText: document.getElementById("loading-text"),
        authContainer: document.getElementById("auth-container"),
        authBtn: document.getElementById("authorize_button"),
        signoutBtn: document.getElementById("signout_button"),
        studentSelect: document.getElementById("studentSelect"),
        classContainer: document.getElementById("classButtons"),
        textarea: document.getElementById("reflectionContent"),
        updateBtn: document.getElementById("updateButton"),
        statusArea: document.getElementById("status-area"),
        currentLabel: document.getElementById("currentLabel"),
        errorMsg: document.getElementById("error-msg"),
      };

      // 1. ç¨‹å¼å…¥å£ï¼šè®€å– config.json
      window.onload = async () => {
        try {
          const resp = await fetch("./config.json");
          if (!resp.ok) throw new Error("æ‰¾ä¸åˆ° config.json æª”æ¡ˆ");
          CONFIG = await resp.json();

          // è¼‰å…¥ Google Scripts
          gapi.load("client", initializeGapiClient);
          google.accounts.id.initialize({
            client_id: CONFIG.clientId,
            callback: handleCredentialResponse,
          });
        } catch (e) {
          showError("åˆå§‹åŒ–å¤±æ•—: " + e.message);
        }
      };

      function showError(msg) {
        dom.spinner.classList.add("hidden");
        dom.loadingText.classList.add("hidden");
        dom.errorMsg.innerText = msg;
      }

      // 2. åˆå§‹åŒ– GAPI (Google API Client)
      async function initializeGapiClient() {
        try {
          await gapi.client.init({
            apiKey: CONFIG.apiKey,
            discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
          });
          gapiInited = true;
          initializeGisClient();
        } catch (err) {
          showError("GAPI åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key");
          console.error(err);
        }
      }

      // 3. åˆå§‹åŒ– GIS (Google Identity Services)
      function initializeGisClient() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CONFIG.clientId,
          scope: "https://www.googleapis.com/auth/spreadsheets", // è«‹æ±‚è®€å¯«æ¬Šé™
          callback: async (resp) => {
            if (resp.error !== undefined) {
              throw resp;
            }
            // ç™»å…¥æˆåŠŸ
            handleAuthSuccess();
          },
        });
        gisInited = true;

        // é¡¯ç¤ºç™»å…¥æŒ‰éˆ•
        dom.spinner.classList.add("hidden");
        dom.loadingText.classList.add("hidden");
        dom.authContainer.classList.remove("hidden");

        // ç¶å®šç™»å…¥é»æ“Š
        dom.authBtn.onclick = () => {
          tokenClient.requestAccessToken({ prompt: "consent" });
        };

        // ç¶å®šç™»å‡º
        dom.signoutBtn.onclick = handleSignout;
      }

      function handleCredentialResponse(response) {
        // Auto-login callback (optional use)
      }

      async function handleAuthSuccess() {
        dom.authContainer.classList.add("hidden");
        dom.spinner.classList.remove("hidden");
        dom.loadingText.classList.remove("hidden");
        dom.loadingText.innerText = "ç™»å…¥æˆåŠŸï¼Œæ­£åœ¨è®€å–å­¸å“¡åå–®...";
        dom.signoutBtn.classList.remove("hidden");

        // ç”¢ç”Ÿèª²ç¨‹æŒ‰éˆ•
        generateClassButtons();

        // è®€å–è³‡æ–™
        await loadStudents();

        // é—œé–‰é®ç½©
        dom.overlay.classList.add("hidden");
      }

      function handleSignout() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken("");
          location.reload(); // ç°¡å–®é‡æ–°æ•´ç†é é¢
        }
      }

      // 4. è®€å–å­¸å“¡åå–®
      async function loadStudents() {
        try {
          const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.sheetId,
            range: `${CONFIG.tabName}!A2:B`, // å‡è¨­ Aæ˜¯åºè™Ÿ Bæ˜¯åå­—
          });

          const rows = response.result.values;
          dom.studentSelect.innerHTML = "<option selected disabled>è«‹é¸æ“‡æ‚¨çš„åå­—</option>";

          if (!rows || rows.length === 0) {
            alert("å·¥ä½œè¡¨ä¸­æ‰¾ä¸åˆ°è³‡æ–™");
            return;
          }

          rows.forEach((row, index) => {
            const name = row[1] || `å­¸å“¡ ${index + 1}`;
            const opt = document.createElement("option");
            opt.value = index + 2; // è©¦ç®—è¡¨ Row Index (å¾1é–‹å§‹ï¼Œä¸”è·³éæ¨™é¡Œ)
            opt.innerText = `${row[0] || ""} ${name}`;
            dom.studentSelect.appendChild(opt);
          });

          dom.studentSelect.disabled = false;

          // ç›£è½é¸æ“‡æ”¹è®Š
          dom.studentSelect.addEventListener("change", (e) => {
            selectedRowIndex = e.target.value;
            fetchReflection(); // è‹¥å·²é¸èª²ç¨‹ï¼Œåˆ‡æ›äººåæ™‚ä¹Ÿè¦é‡æŠ“
          });
        } catch (err) {
          console.error(err);
          alert("è®€å–åå–®å¤±æ•—ï¼Œè«‹ç¢ºèªæ‚¨æ˜¯å¦æœ‰æ­¤æ–‡ä»¶çš„æª¢è¦–æ¬Šé™ã€‚");
        }
      }

      // ç”¢ç”ŸæŒ‰éˆ•
      function generateClassButtons() {
        dom.classContainer.innerHTML = "";
        CLASS_NAMES.forEach((name, idx) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn btn-outline-primary btn-class";
          btn.innerText = name;
          btn.onclick = () => selectClass(idx, btn);
          dom.classContainer.appendChild(btn);
        });

        // ç¶å®šæ›´æ–°æŒ‰éˆ•
        dom.updateBtn.onclick = updateReflection;
      }

      // 5. é¸æ“‡èª²ç¨‹èˆ‡è®€å–å¿ƒå¾—
      function selectClass(index, btnEl) {
        // æ¨£å¼è™•ç†
        document.querySelectorAll("#classButtons .btn").forEach((b) => {
          b.classList.remove("btn-primary");
          b.classList.add("btn-outline-primary");
        });
        btnEl.classList.remove("btn-outline-primary");
        btnEl.classList.add("btn-primary");

        selectedColLetter = CLASS_COLUMNS[index];
        dom.currentLabel.innerText = CLASS_NAMES[index];

        fetchReflection();
      }

      async function fetchReflection() {
        if (!selectedRowIndex || !selectedColLetter) return;

        dom.textarea.disabled = true;
        dom.textarea.value = "è®€å–ä¸­...";
        dom.updateBtn.disabled = true;
        dom.statusArea.innerText = "";

        try {
          const range = `${CONFIG.tabName}!${selectedColLetter}${selectedRowIndex}`;
          const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.sheetId,
            range: range,
          });

          const val = response.result.values;
          dom.textarea.value = val && val.length > 0 ? val[0][0] : "";
          dom.textarea.disabled = false;
          dom.updateBtn.disabled = false;
        } catch (err) {
          console.error(err);
          dom.textarea.value = "è®€å–éŒ¯èª¤";
          dom.statusArea.innerText = "è®€å–å¤±æ•— (è«‹ç¢ºèªç¶²è·¯æˆ–æ¬Šé™)";
          dom.statusArea.className = "mt-3 text-center text-danger fw-bold";
        }
      }

      // 6. æ›´æ–°å¯«å…¥
      async function updateReflection() {
        if (!selectedRowIndex || !selectedColLetter) return;

        const content = dom.textarea.value;
        const range = `${CONFIG.tabName}!${selectedColLetter}${selectedRowIndex}`;

        dom.updateBtn.disabled = true;
        dom.updateBtn.innerText = "æ›´æ–°ä¸­...";

        try {
          await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: CONFIG.sheetId,
            range: range,
            valueInputOption: "RAW",
            resource: { values: [[content]] },
          });

          dom.statusArea.innerText = "âœ… æ›´æ–°æˆåŠŸï¼";
          dom.statusArea.className = "mt-3 text-center text-success fw-bold";

          // 3ç§’å¾Œæ¸…é™¤æˆåŠŸè¨Šæ¯
          setTimeout(() => {
            dom.statusArea.innerText = "";
          }, 3000);
        } catch (err) {
          console.error(err);
          dom.statusArea.innerText = "âŒ æ›´æ–°å¤±æ•— (æ‚¨æ˜¯å¦æœ‰ç·¨è¼¯æ¬Šé™ï¼Ÿ)";
          dom.statusArea.className = "mt-3 text-center text-danger fw-bold";
        } finally {
          dom.updateBtn.innerText = "æ›´æ–°å„²å­˜åˆ° Google æ–‡ä»¶";
          dom.updateBtn.disabled = false;
        }
      }
    </script>
  </body>
</html>
